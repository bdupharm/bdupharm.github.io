<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Zope Transaction Manager Not Committing Your Changes? Try Marking the Session as Dirty · A Pharmacist's Adventures in Software Engineering</title><meta name="description" content="Zope Transaction Manager Not Committing Your Changes? Try Marking the Session as Dirty - Bo Du"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.linkedin.com/in/bo-du-pharmd-76b29371" target="_blank" class="nav-list-link">LINKEDIN</a></li><li class="nav-list-item"><a href="https://github.com/bdupharm" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Zope Transaction Manager Not Committing Your Changes? Try Marking the Session as Dirty</h1><div class="post-info">Apr 24, 2016</div><div class="post-content"><p>If you’re reading this post, then you are likely familiar with the <code>Pyramid</code> python web framework, the zope transaction manager (zope tm) and <code>SQLAlchemy</code>.<br>The zope tm is smart enough to know when your session is dirty most of the time. But what if you want to execute raw SQL directly? The zope tm will not know that the session is dirty and will not commit your changes.</p>
<p>Solution? Manually mark the session as dirty when you execute raw SQL yourself.</p>
<a id="more"></a>
<p>Let’s say you have a database session object like this:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session = scoped_session(sessionmaker())</span><br></pre></td></tr></table></figure></p>
<p>And you have code written like this:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using the ORM</span></span><br><span class="line"><span class="comment"># Zope tm knows whatsup. Your changes are committed.</span></span><br><span class="line">user = model.User(first_name=<span class="string">"Kanye"</span>,</span><br><span class="line">                  last_name=<span class="string">"West"</span>)</span><br><span class="line">session.add(user)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Execute a raw SQL statement</span></span><br><span class="line"><span class="comment"># Zope tm has no idea wtf your doing. Your changes are not committed.</span></span><br><span class="line">session.execute(</span><br><span class="line">    model.User.__table__.insert()</span><br><span class="line">        <span class="comment"># first name, last name </span></span><br><span class="line">        .values((<span class="string">"kanye"</span>, <span class="string">"west"</span>))</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>In the second example, you need to mark the session as dirty in order for zope tm to commit the transaction.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zope.sqlalchemy <span class="keyword">import</span> mark_changed</span><br><span class="line"></span><br><span class="line">mark_changed(session())</span><br></pre></td></tr></table></figure></p>
<p>Make sure you call <code>mark_changed</code> on the actual <code>session</code> object and not the <code>scoped_session</code> object or you will get an error like this:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dropped a debugger in my application</span></span><br><span class="line">ipdb&gt; session()</span><br><span class="line">&lt;sqlalchemy.orm.session.Session object at <span class="number">0x7f0bb46a4a50</span>&gt;</span><br><span class="line">ipdb&gt; session</span><br><span class="line">&lt;sqlalchemy.orm.scoping.scoped_session object at <span class="number">0x7996590</span>&gt;</span><br><span class="line">ipdb&gt; mark_changed(session)</span><br><span class="line">*** AttributeError: <span class="string">'scoped_session'</span> object has no attribute <span class="string">'twophase'</span></span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="about-me"><img src="/portrait.jpg"><div class="description">Hi, I'm a software engineer and pharmacist currently working at Truveris, a health IT startup in NYC. At work, I focus on building the back-end infrastructure while weaving in and out of front-end projects.</div></div></section><footer><div class="paginator"><a href="/2016/05/05/Debugging-Javascript-in-IE8/" class="prev">上一篇</a><a href="/2016/04/21/Casting-in-PostgreSQL-A-Shallow-Wade-Through-Comparisons/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'bdupharm';
var disqus_identifier = '2016/04/24/Zope-Transaction-Manager-Not-Committing-Your-Changes-Try-Marking-the-Session-as-Dirty/';
var disqus_title = 'Zope Transaction Manager Not Committing Your Changes? Try Marking the Session as Dirty';
var disqus_url = 'http://blog.bodu.io/2016/04/24/Zope-Transaction-Manager-Not-Committing-Your-Changes-Try-Marking-the-Session-as-Dirty/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//bdupharm.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 <a href="http://blog.bodu.io">Bo Du</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-76488168-1",'auto');ga('send','pageview');</script></body></html>